name: Upstream Stash Release
on:
  push:
    branches:
      - main
    paths:
      - 'UPSTREAM_VERSION'
  workflow_dispatch:

jobs:
  docker:
    uses: ./.github/workflows/docker.yml
    with:
      variant: full
      skip_merge: true
    secrets: inherit
    permissions:
      packages: write
      contents: read
      attestations: write
      id-token: write
  docker-lite:
    uses: ./.github/workflows/docker.lite.yml
    with:
      variant: lite
      skip_merge: true
    secrets: inherit
    permissions:
      packages: write
      contents: read
      attestations: write
      id-token: write
  
  merge:
    runs-on: ubuntu-latest
    needs: [docker, docker-lite]
    permissions:
      packages: write
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Get Stash Version
        id: get_version
        run: |
          VER=$(cat UPSTREAM_VERSION)
          echo "UPSTREAM_VERSION=$VER" >> $GITHUB_OUTPUT
          echo "UPSTREAM_VERSION=$VER" >> $GITHUB_ENV

      - name: Download all digests
        uses: actions/download-artifact@v5
        with:
          path: ${{ runner.temp }}/digests
          pattern: digests-*
          merge-multiple: true

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create full image manifest
        id: meta_full
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ github.repository_owner }}/stash-jellyfin-ffmpeg
            ${{ github.repository_owner }}/stash
            ghcr.io/${{ github.repository_owner }}/stash
          flavor: latest=true
          tags: |
            type=raw,priority=997,${{ steps.get_version.outputs.UPSTREAM_VERSION }}
            type=sha,priority=998,prefix=${{ steps.get_version.outputs.UPSTREAM_VERSION }}-
            type=sha,priority=999,prefix=,suffix=,format=short

      - name: Create lite image manifest
        id: meta_lite
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ github.repository_owner }}/stash-jellyfin-ffmpeg
            ${{ github.repository_owner }}/stash
            ghcr.io/${{ github.repository_owner }}/stash
          flavor: latest=false
          tags: |
            type=raw,priority=996,lite-${{ steps.get_version.outputs.UPSTREAM_VERSION }}
            type=sha,priority=997,prefix=lite-${{ steps.get_version.outputs.UPSTREAM_VERSION }}-
            type=sha,priority=998,prefix=lite-,suffix=,format=short
            type=raw,priority=999,lite

      - name: Create and push manifests
        working-directory: ${{ runner.temp }}/digests
        run: |
          # Get full variant digests (amd64 and arm64 only)
          FULL_DIGESTS=$(ls -1 | grep '^[0-9a-f]\{64\}$' | head -2)
          
          # Get lite variant digests (all 4 platforms)
          LITE_DIGESTS=$(ls -1 | grep '^[0-9a-f]\{64\}$' | tail -4)
          
          # Create full image tags
          FULL_TAGS=$(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON_META_FULL")
          
          # Create lite image tags
          LITE_TAGS=$(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON_META_LITE")
          
          # Build full image references
          FULL_REFERENCES=""
          for digest in $FULL_DIGESTS; do
            FULL_REFERENCES="${FULL_REFERENCES} ${{ github.repository_owner }}/stash-jellyfin-ffmpeg@sha256:${digest}"
            FULL_REFERENCES="${FULL_REFERENCES} ${{ github.repository_owner }}/stash@sha256:${digest}"
            FULL_REFERENCES="${FULL_REFERENCES} ghcr.io/${{ github.repository_owner }}/stash@sha256:${digest}"
          done
          
          # Build lite image references
          LITE_REFERENCES=""
          for digest in $LITE_DIGESTS; do
            LITE_REFERENCES="${LITE_REFERENCES} ${{ github.repository_owner }}/stash-jellyfin-ffmpeg@sha256:${digest}"
            LITE_REFERENCES="${LITE_REFERENCES} ${{ github.repository_owner }}/stash@sha256:${digest}"
            LITE_REFERENCES="${LITE_REFERENCES} ghcr.io/${{ github.repository_owner }}/stash@sha256:${digest}"
          done
          
          # Create and push full manifest
          echo "Creating full image manifest..."
          docker buildx imagetools create ${FULL_TAGS} ${FULL_REFERENCES}
          
          # Create and push lite manifest
          echo "Creating lite image manifest..."
          docker buildx imagetools create ${LITE_TAGS} ${LITE_REFERENCES}

      - name: Inspect images
        run: |
          echo "Full image:"
          docker buildx imagetools inspect ${{ github.repository_owner }}/stash:${{ steps.get_version.outputs.UPSTREAM_VERSION }}
          echo "\nLite image:"
          docker buildx imagetools inspect ${{ github.repository_owner }}/stash:lite-${{ steps.get_version.outputs.UPSTREAM_VERSION }}